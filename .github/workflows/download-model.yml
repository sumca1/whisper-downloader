name: Download Whisper Model

on:
  workflow_dispatch:  # ××¤×©×¨ ×”×¨×¦×” ×™×“× ×™×ª
  push:
    branches: [ main ]

jobs:
  download-model:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests huggingface_hub
    
    - name: Download Whisper Model
      env:
        HF_TOKEN: ${{ secrets.HF_TOKEN }}
      run: |
        python << 'EOF'
        import requests
        import os
        from pathlib import Path
        
        token = os.environ.get('HF_TOKEN')
        
        files = {
            "config.json": "https://huggingface.co/guillaumekln/faster-whisper-small/resolve/main/config.json",
            "model.bin": "https://huggingface.co/guillaumekln/faster-whisper-small/resolve/main/model.bin",
            "tokenizer.json": "https://huggingface.co/guillaumekln/faster-whisper-small/resolve/main/tokenizer.json",
            "vocabulary.txt": "https://huggingface.co/guillaumekln/faster-whisper-small/resolve/main/vocabulary.txt",
        }
        
        output_dir = Path("whisper-model")
        output_dir.mkdir(exist_ok=True)
        
        for filename, url in files.items():
            print(f"ğŸ“¥ Downloading {filename}...")
            
            headers = {"Authorization": f"Bearer {token}"}
            response = requests.get(url, headers=headers, stream=True)
            
            if response.status_code == 200:
                filepath = output_dir / filename
                total = int(response.headers.get('content-length', 0))
                downloaded = 0
                
                with open(filepath, 'wb') as f:
                    for chunk in response.iter_content(8192):
                        if chunk:
                            f.write(chunk)
                            downloaded += len(chunk)
                            if total:
                                pct = (downloaded / total) * 100
                                print(f"\r  {pct:.1f}%", end='')
                
                print(f"\nâœ… {filename} downloaded!")
            else:
                print(f"âŒ Failed: {response.status_code}")
        
        print("\nâœ… All files downloaded!")
        EOF
    
    - name: Create ZIP archive
      run: |
        cd whisper-model
        zip -r ../whisper-model.zip .
        cd ..
        ls -lh whisper-model.zip
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v3
      with:
        name: whisper-model
        path: whisper-model.zip
        retention-days: 7
    
    - name: Summary
      run: |
        echo "âœ… Model downloaded successfully!"
        echo "ğŸ“¦ Download the artifact from the Actions tab"
        echo "ğŸ”— Or use the direct download link in the workflow run"
